(()=>{"use strict";function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(t,r,a){return(r=function(t){var r=function(t){if("object"!=e(t)||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var a=r.call(t,"string");if("object"!=e(a))return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==e(r)?r:r+""}(r))in t?Object.defineProperty(t,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[r]=a,t}var r,a,s,i;!function(e){e.ADD_VIDEO_PORT="add_video_port",e.ADD_SHADOW_PORT="add_shadow_port",e.ADD_VIDEO_PROCESSOR="add_video_processor",e.PROCESSOR_READY="processor_ready",e.PROCESSOR_ERROR="processor_error"}(r||(r={})),function(e){e.ADD_SHARE_PORT="add_share_port",e.ADD_SHADOW_PORT="add_shadow_port",e.ADD_SHARE_PROCESSOR="add_share_processor",e.ADD_SHARE_ENCODE_PORT="add_share_encode_port",e.PROCESSOR_READY="processor_ready",e.PROCESSOR_ERROR="processor_error"}(a||(a={})),function(e){e.INIT_PROCESSOR="init_processor",e.UNINIT_PROCESSOR="uninit_processor",e.INIT_OUTPUT_CANVAS="init_output_canvas",e.OUTPUT_WRITABLE_STREAM="output_writable_stream",e.INPUT_READABLE_STREAM="input_readable_stream",e.FRAME_DATA="frame_data",e.START_REQUEST_FRAME="start_request_frame",e.STOP_REQUEST_FRAME="stop_request_frame",e.REQUEST_FRAME="request_frame",e.FRAME_CALLBACK="frame_callback",e.RESOLUTION_CHANGE="RESOLUTION_CHANGE",e.PROCESSOR_WORKER_ERROR="PROCESSOR_WORKER_ERROR"}(s||(s={})),i||(i={});let o=!1;const n=new Map,c=new Map,h=new Map,l=new Map;function d(e,t){n.set(e,t)}function u(e){let t;"string"==typeof e?t=e:e instanceof ErrorEvent?t=e.error:e instanceof PromiseRejectionEvent&&(t=e.reason),self.postMessage({cmd:s.PROCESSOR_WORKER_ERROR,data:t})}self.addEventListener("error",u),self.addEventListener("unhandledrejection",u);class m{constructor(e,t){this.port=e,this.options=t,this.getOutput=()=>null}onInit(){}onUninit(){}processFrame(e,t){throw new Error("please implement the processFrame method")}}class p{constructor(e,r,a){t(this,"requestFrame",(e=>()=>{this.frameReader.read().then((t=>{let{value:r,done:a}=t;a?(clearTimeout(this.readFrameTimer),this.readFrameTimer=0):(this.updateOutputCanvas(r),this.processFrame(r),this.readFrameTimer=setTimeout((()=>this.requestFrame(e)()),1e3/e.data.frameRate-4))})).catch((()=>{clearTimeout(this.readFrameTimer),this.readFrameTimer=0}))})),t(this,"frameCallback",(e=>{const t=h.get(this.processorName);t&&t.postMessage({cmd:s.FRAME_CALLBACK,frame:e});try{this.port.postMessage({cmd:s.FRAME_CALLBACK,frame:e}),e.close()}catch(e){console.error("errors while posting message in frameReader, error:",e)}finally{e&&e.close()}})),t(this,"callback",((e,t)=>{this.port.postMessage({cmd:e,data:t})})),t(this,"processFrame",(e=>{if(this.processor){var t;const r=t=>{if(t){let t;this.pVideoFrameCount++,e.close(),this.frameWriter?(t=this.generateVideoFrame(this.outputCanvas),this.frameWriter.write(t).finally((()=>{t.close()})),this.checkAndCopyBack(this.outputCanvas)):this.isInternalOutputCanvas&&(t=this.generateVideoFrame(this.outputCanvas),t&&this.frameCallback(t))}else this.fVideoFrameCount++,this.frameWriter?(this.checkAndCopyBack(this.outputCanvas),this.frameWriter.write(e).finally((()=>{e.close()}))):e&&this.frameCallback(e)};this.tickInWorker&&(null===this.preVideoWidth?this.preVideoWidth=e.visibleRect.width:this.preVideoWidth!=e.visibleRect.width&&(this.preVideoWidth=e.visibleRect.width,this.port.postMessage({cmd:s.RESOLUTION_CHANGE,data:{width:e.visibleRect.width,height:e.visibleRect.height}}))),this.cVideoFrameCount++;const a=this.processor.processFrame(e,this.outputCanvas);a.then?null===(t=a.then)||void 0===t||t.call(a,(e=>r(e))):r(a)}else this.frameCallback(e)})),this.outputCanvas=null,this.frameWriter=null,this.frameReader=null,this.requestFrameInterval=0,this.port=e,this.processor=r,this.processorName=a,this.outputCanvasReady,this.outputPromise=new Promise((e=>{this.outputCanvasReady=e})),this.preVideoWidth=null,this.tickInWorker=!1,this.VideoFrameNeeded=!0,this.pHealthCheckInterval=0,this.cVideoFrameCount=0,this.pVideoFrameCount=0,this.fVideoFrameCount=0,this.isInternalOutputCanvas=!1}async onMessage(e,t){var r,a,i;switch(e){case s.INIT_OUTPUT_CANVAS:t.canvas?(this.outputCanvas=t.canvas,this.isInternalOutputCanvas=!1):(this.outputCanvas=new OffscreenCanvas(1,1),this.isInternalOutputCanvas=!0),this.outputCanvas.addEventListener("webglcontextlost",(()=>{u("pccl")})),this.outputCanvas.addEventListener("webglcontextrestored",(()=>{u("pccs")})),null===(r=this.outputCanvasReady)||void 0===r||r.call(this);break;case s.OUTPUT_WRITABLE_STREAM:this.frameWriter=t.writableStream.getWriter();break;case s.INPUT_READABLE_STREAM:this.frameReader=t.readableStream.getReader();break;case s.FRAME_DATA:{this.outputCanvas||await this.outputPromise;const e=t.frame;if(this.updateOutputCanvas(e),t.captureStream)return void this.processor.processFrame(e,this.outputCanvas).then((()=>{e.close()}));this.processFrame(e)}break;case s.START_REQUEST_FRAME:this.VideoFrameNeeded=!!t.VideoFrameNeeded,this.tickInWorker=!0,this.frameReader?this.requestFrame({data:t})(this.port):this.requestFrameInterval||(this.requestFrameInterval=setInterval((()=>{this.port.postMessage({cmd:s.REQUEST_FRAME})}),1e3/t.frameRate-4));break;case s.STOP_REQUEST_FRAME:this.tickInWorker=!1,this.requestFrameInterval&&(clearInterval(this.requestFrameInterval),this.requestFrameInterval=0),this.readFrameTimer&&(clearTimeout(this.readFrameTimer),this.readFrameTimer=0),null===(a=this.frameReader)||void 0===a||null===(i=a.cancel)||void 0===i||i.call(a)}}updateOutputCanvas(e){this.outputCanvas.width!==e.visibleRect.width&&(this.outputCanvas.width=e.visibleRect.width),this.outputCanvas.height!==e.visibleRect.height&&(this.outputCanvas.height=e.visibleRect.height)}checkAndCopyBack(e){if(this.VideoFrameNeeded)try{const t=this.generateVideoFrame(e);t&&this.frameCallback(t)}catch(e){console.error("checkAndCopyBack() Failed to generate frame:",e)}}generateVideoFrame(e){if(!e)return null;let t,r;try{return t=e.transferToImageBitmap(),r=new VideoFrame(t,{timestamp:1e3*performance.now()}),r}finally{var a;null===(a=t)||void 0===a||a.close()}}startHealthCheck(){this.pHealthCheckInterval||(this.pHealthCheckInterval=setInterval((()=>{u("VPCFP:".concat(this.cVideoFrameCount,"-").concat(this.fVideoFrameCount,"-").concat(this.pVideoFrameCount))}),1e4))}stopHealthCheck(){clearInterval(this.pHealthCheckInterval),this.pHealthCheckInterval=0}destroy(){var e,t;null===(e=this.frameReader)||void 0===e||e.cancel(),null===(t=this.frameWriter)||void 0===t||t.close()}}self.addEventListener("message",(function(e){const t=e.data;switch(t.command){case a.ADD_SHARE_PROCESSOR:o||((i=self).registerProcessor=d,i.ShareProcessor=m,o=!0);try{if(self,importScripts(t.url),t.port.start(),!c.has(t.name)){const e=n.get(t.name);e&&c.set(t.name,new e(t.port,t.options))}self.postMessage({cmd:a.PROCESSOR_READY,name:t.name})}catch(e){console.error(e),self.postMessage({cmd:a.PROCESSOR_ERROR,name:t.name})}break;case a.ADD_SHARE_PORT:(r=t.data).start(),r.addEventListener("message",(e=>{const{cmd:t,processorName:a}=e.data;if(l.get(a)||t===s.UNINIT_PROCESSOR||l.set(a,new p(r,c.get(a),a)),t===s.INIT_PROCESSOR){const e=l.get(a);e.startHealthCheck(),e.outputPromise.then((()=>{var t;c.get(a).getOutput=()=>e.outPutCanvas,null===(t=c.get(a))||void 0===t||t.onInit()}))}else if(t===s.UNINIT_PROCESSOR){var i;null===(i=c.get(a))||void 0===i||i.onUninit();const e=l.get(a);e&&(e.stopHealthCheck(),e.destroy()),l.delete(a)}else{var o;a&&(null===(o=l.get(a))||void 0===o||o.onMessage(t,e.data))}}));break;case a.ADD_SHADOW_PORT:{const e=t.data;e.start(),e.addEventListener("message",(t=>{const{cmd:r,processorName:a}=t.data;r===s.INIT_PROCESSOR?h.set(a,e):r===s.UNINIT_PROCESSOR&&h.delete(a)}))}}var r,i}))})();
//# sourceMappingURL=https://d1cdksi819e9z7.cloudfront.net/sourcemap/share_processor.min.js-4db3b1d0518b42059ffa.map