!function(t){var e={};function s(i){if(e[i])return e[i].exports;var a=e[i]={i:i,l:!1,exports:{}};return t[i].call(a.exports,a,a.exports,s),a.l=!0,a.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)s.d(i,a,function(e){return t[e]}.bind(null,a));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e){const s=0,i=1,a=2,h=3;class r{constructor(){this.cacheSize=0,this.sameCacheSizeCounter=0}shouldSendCacheSize(t){return t===this.cacheSize&&this.sameCacheSizeCounter++,(this.cacheSize!==t||200===this.sameCacheSizeCounter)&&(this.sameCacheSizeCounter=0,this.cacheSize=t,!0)}}class o{constructor(){this.buffList=[],this.cacheMinSize=4,this.cacheMaxSize=16,this.cacheSize=this.cacheMinSize,this.onCacheSizeChange=null,this.onrollbackbuffer=null,this.onneedmoredata=null,this.isReady=!1,this.cacheSizeController=new r}push(t){this.isReady=!0,this.buffList.push({buff:t,offset:0})}copy(t,e,s,i){return t.length-e<=s.length-i?(0===e?s.set(t,i):s.set(t.subarray(e),i),t.length-e):(s.set(t.subarray(e,e+s.length-i),i),s.length-i)}increaseCacheSize(){this.isReady&&this.cacheSize++,this.cacheSize>this.cacheMaxSize&&(this.cacheSize=this.cacheMaxSize),this.onCacheSizeChange&&this.isReady&&this.cacheSizeController.shouldSendCacheSize(this.cacheSize)&&this.onCacheSizeChange(this.cacheSize)}copyTo(t){if(0===this.buffList.length)return t.fill(0),void this.increaseCacheSize();let e=this.buffList[0];if(e.buff.length-e.offset>=t.length)this.copy(e.buff,e.offset,t,0),e.offset+=t.length,e.offset===e.buff.length&&(this.buffList.shift(),this.onrollbackbuffer&&this.onrollbackbuffer(e.buff));else{if(this.buffList.length<2)return t.fill(0),void this.increaseCacheSize();let s=this.copy(e.buff,e.offset,t,0);this.buffList.shift(),this.onrollbackbuffer&&this.onrollbackbuffer(e.buff),e=this.buffList[0],s=this.copy(e.buff,e.offset,t,s),e.offset+=s}}requestMoreData(){this.buffList.length<this.cacheSize&&this.onneedmoredata&&this.onneedmoredata()}hasData(){return this.buffList.length>=2}}class n{constructor(t){this.buffList=[],this.frameLength=t,this.onframedata=null}copy(t,e,s,i){return t.length-e<=s.length-i?(0===e?s.set(t,i):s.set(t.subarray(e),i),t.length-e):(s.set(t.subarray(e,e+s.length-i),i),s.length-i)}rollbackbuffer(t){this.buffList.push({buff:t,offset:0})}push(t){0===this.buffList.length&&this.buffList.push({buff:new Float32Array(this.frameLength),offset:0});let e=this.buffList[0];if(e.buff.length-e.offset>=t.length){let s=this.copy(t,0,e.buff,e.offset);e.offset+=s,e.buff.length===e.offset&&(this.buffList.shift(),this.onframedata&&this.onframedata(e.buff))}else{let s=this.copy(t,0,e.buff,e.offset);this.buffList.shift(),this.onframedata&&this.onframedata(e.buff),t.length>s&&this.push(t.subarray(s))}}}class u{constructor(t,e){this.context=e,this.decodePort=null,this.encodePort=null,this.captureSize=t/100,this.playBuffer=new o,this.playBuffer.onrollbackbuffer=t=>{this.decodePort},this.playBuffer.onneedmoredata=()=>{this.decodePort&&this.decodePort.postMessage({status:i})},this.playBuffer.onCacheSizeChange=t=>{this.decodePort&&this.decodePort.postMessage({status:h,cacheSize:t})},this.quantum=new Float32Array(128),this.captureBuffer=new n(this.captureSize),this.captureBuffer.onframedata=t=>{this.encodePort&&this.encodePort.postMessage({command:a,buffer:t},[t.buffer])}}setDecodePort(t){this.decodePort&&this.decodePort.close(),this.decodePort=t,this.decodePort.onmessage=this.handleDecodeData.bind(this)}setEncodePort(t){this.encodePort&&this.encodePort.close(),this.encodePort=t,this.encodePort.onmessage=this.handleEncodeData.bind(this)}handleDecodeData(t){if(this.context.isPlaying&&this.playBuffer.push(t.data.data),this.context.isCapturing&&t.data.aec){const e={command:"EchoCancel",data:t.data.aec,channels:t.data.channels,sampleHz:t.data.sampleHz};this.encodePort.postMessage(e,[e.data.buffer])}}handleEncodeData(t){switch(t.data.event){case s:this.captureBuffer.rollbackbuffer(t.data.buffer)}}requestMoreData(){this.playBuffer.requestMoreData()}close(){this.decodePort&&(this.decodePort=null,this.decodePort.close()),this.encodePort&&(this.encodePort=null,this.encodePort.close())}write(t){this.captureBuffer.push(t)}read(){return this.playBuffer.copyTo(this.quantum),this.requestMoreData(),this.quantum}}class f{constructor(t,e,s){if(this.STATE_READ_READY=0,this.STATE_READ_INDEX=1,this.STATE_WRITE_READY=2,this.STATE_WRITE_INDEX=3,this.STATE_DATA_COUNT=4,this.STATE_CACHE_SIZE=5,this.STATY_READY_NO=0,this.STATY_READY_YES=1,this.sabState=new Uint32Array(t),this.sabBuffer=new Float32Array(e),this.perFrameLength=s,this.bufferLen=this.sabBuffer.length,this.supportSpecialOptimization=this.bufferLen%s==0,this.bufferIndex=null,this.supportSpecialOptimization){let t=this.bufferLen/s;this.bufferIndex=[];for(let e=0;e<t;e++)this.bufferIndex.push(this.sabBuffer.subarray(e*s,e*s+s))}this.placeBuffer=new Float32Array(this.perFrameLength),this.QUANTUM_SIZE=128,this.CACHE_SIZE_MAX_VALUE=Math.floor(Math.floor(this.bufferLen/this.QUANTUM_SIZE)/2),this.CACHE_SIZE_MIN_VALUE=6,this.CACHE_SIZE_MAX_VALUE<this.CACHE_SIZE_MIN_VALUE&&(this.CACHE_SIZE_MAX_VALUE=this.CACHE_SIZE_MIN_VALUE),this.setCacheSize(this.CACHE_SIZE_MIN_VALUE),this._counter=0,this.onCacheSizeChange=null,this.cacheSizeController=new r}getCacheSize(){return Atomics.load(this.sabState,this.STATE_CACHE_SIZE)}setCacheSize(t){t>this.CACHE_SIZE_MAX_VALUE&&(t=this.CACHE_SIZE_MAX_VALUE),t<this.CACHE_SIZE_MIN_VALUE&&(t=this.CACHE_SIZE_MIN_VALUE),this.onCacheSizeChange&&this.cacheSizeController.shouldSendCacheSize(t)&&this.onCacheSizeChange(t),Atomics.store(this.sabState,this.STATE_CACHE_SIZE,t)}setQuantumSize(t){this.QUANTUM_SIZE=t,this.CACHE_SIZE_MAX_VALUE=Math.floor(Math.floor(this.bufferLen/this.QUANTUM_SIZE)/2),this.CACHE_SIZE_MAX_VALUE<this.CACHE_SIZE_MIN_VALUE&&(this.CACHE_SIZE_MAX_VALUE=this.CACHE_SIZE_MIN_VALUE)}isNeedMoreData(){let t=Atomics.load(this.sabState,this.STATE_CACHE_SIZE);return Atomics.load(this.sabState,this.STATE_DATA_COUNT)<t*this.QUANTUM_SIZE}shouldAdjustCacheBuffer(){this._counter>0&&this.setCacheSize(this.getCacheSize()+1)}clear(){this.sabState&&(this.sabState[this.STATE_READ_READY]=0,this.sabState[this.STATE_READ_INDEX]=0,this.sabState[this.STATE_WRITE_READY]=0,this.sabState[this.STATE_WRITE_INDEX]=0,this.sabState[this.STATE_DATA_COUNT]=0),this._counter=0}setWriteReady(){this.sabState[this.STATE_WRITE_READY]=this.STATY_READY_YES}isReady(){return this.sabState[this.STATE_WRITE_READY]&&this.sabState[this.STATE_READ_READY]}getDataCount(){return Atomics.load(this.sabState,this.STATE_DATA_COUNT)}write(t){if(t.length!==this.perFrameLength)return;let e=this.sabState[this.STATE_READ_READY];return this.sabState[this.STATE_WRITE_READY]||(this.sabState[this.STATE_WRITE_READY]=this.STATY_READY_YES,this.sabState[this.STATE_WRITE_INDEX]=0),e?this.supportSpecialOptimization?this.writeSpecial(t):this.writeNormal(t):void 0}writeNormal(t){let e=this.sabState[this.STATE_WRITE_INDEX];if(this.bufferLen-e>=this.perFrameLength)this.sabBuffer.set(t,e);else{let s=t.subarray(0,this.bufferLen-e),i=t.subarray(s.length);this.sabBuffer.set(s,e),this.sabBuffer.set(i)}(e+=this.perFrameLength)>=this.bufferLen&&(e-=this.bufferLen),this.sabState[this.STATE_WRITE_INDEX]=e,Atomics.add(this.sabState,this.STATE_DATA_COUNT,this.perFrameLength)}writeSpecial(t){let e=this.sabState[this.STATE_WRITE_INDEX];this.bufferIndex[e].set(t),e=(e+1)%this.bufferIndex.length,this.sabState[this.STATE_WRITE_INDEX]=e,Atomics.add(this.sabState,this.STATE_DATA_COUNT,this.perFrameLength)}read(){let t=this.sabState[this.STATE_READ_READY],e=this.sabState[this.STATE_WRITE_READY];if(t||(this.sabState[this.STATE_READ_READY]=this.STATY_READY_YES,this.sabState[this.STATE_READ_INDEX]=0),!e)return null;let s=this.supportSpecialOptimization?this.readSpecial():this.readNormal();return null===s?this.shouldAdjustCacheBuffer():this._counter++,s}readNormal(){let t=this.sabState[this.STATE_READ_INDEX],e=Atomics.load(this.sabState,this.STATE_DATA_COUNT);if(e<this.perFrameLength)return null;if(e>this.bufferLen){let s=Math.ceil((e-this.bufferLen)/this.perFrameLength)+1;t=(s*this.perFrameLength+t)%this.bufferLen,Atomics.sub(this.sabState,this.STATE_DATA_COUNT,s*this.perFrameLength)}let s=null;if(this.bufferLen-t>=this.perFrameLength)s=this.sabBuffer.subarray(t,t+this.perFrameLength);else{let e=this.sabBuffer.subarray(t),i=this.sabBuffer.subarray(0,this.perFrameLength-e.length);(s=this.placeBuffer).set(e),s.set(i,e.length)}return(t+=this.perFrameLength)>=this.bufferLen&&(t-=this.bufferLen),this.sabState[this.STATE_READ_INDEX]=t,Atomics.sub(this.sabState,this.STATE_DATA_COUNT,this.perFrameLength),s}readSpecial(){let t=this.sabState[this.STATE_READ_INDEX],e=Atomics.load(this.sabState,this.STATE_DATA_COUNT);if(e<this.perFrameLength)return null;if(e>this.bufferLen){let s=Math.ceil((e-this.bufferLen)/this.perFrameLength)+1;t=(s+t)%this.bufferIndex.length,Atomics.sub(this.sabState,this.STATE_DATA_COUNT,s*this.perFrameLength)}let s=this.bufferIndex[t];return t=(t+1)%this.bufferIndex.length,this.sabState[this.STATE_READ_INDEX]=t,Atomics.sub(this.sabState,this.STATE_DATA_COUNT,this.perFrameLength),s}}const c="undefined"!=typeof SharedArrayBuffer;registerProcessor("zoomAudioWorklet",class extends AudioWorkletProcessor{static get parameterDescriptors(){return[{name:"pcm",defaultValue:1}]}constructor(){super(),this.port.onmessage=this.handleMessage.bind(this),this.isPlaying=!1,this.isCapturing=!1,this.SABConstructor(),this.noSABConstructor()}SABConstructor(){this.sampleRate_=0,this.g_sharedbuffer=null,this.encodeSAB=null,this.decodeSAB=null,this.aecSAB=null,this.audioEncodePort=null,this.audioDecodePort=null}noSABConstructor(){this.audioProcessBuffer=new u(sampleRate,this),this.isRunning=!0}handleMessage(t){const{status:e,data:s}=t.data;switch(e){case"data":console.info("droped audio data before init");break;case"stopPlayAudio":this.isPlaying=!1;break;case"startPlayAudio":this.isPlaying=!0;break;case"StartCaptureAudio":this.isCapturing=!0;break;case"sampleRate":this.sampleRate_=s;break;default:c?this.handleMessageForSAB(t):this.handleMessageForNoSAB(t)}}handleMessageForSAB(t){const{status:e,data:s}=t.data;switch(e){case"encodeAudioPort":this.audioEncodePort&&this.audioEncodePort.close(),this.audioEncodePort=t.ports[0];break;case"decodeAudioPort":this.audioDecodePort&&this.audioDecodePort.close(),this.audioDecodePort=t.ports[0],this.audioDecodePort.onmessage=function(t){if(this.isCapturing&&t.data.aec){const e={command:"EchoCancel",data:t.data.aec,channels:t.data.channels,sampleHz:t.data.sampleHz};this.audioEncodePort.postMessage(e,[e.data.buffer])}};break;case"close":break;case"sharedBuffer":this.g_sharedbuffer=s,this.g_sharedbuffer&&(this.encodeSAB=new f(this.g_sharedbuffer.inputState,this.g_sharedbuffer.inputBuffer,128),this.decodeSAB=new f(this.g_sharedbuffer.outputState,this.g_sharedbuffer.outputBuffer,128),this.aecSAB=new f(this.g_sharedbuffer.aecState,this.g_sharedbuffer.aecBuffer,128),this.decodeSAB.onCacheSizeChange=t=>{this.audioDecodePort&&this.audioDecodePort.postMessage({status:h,cacheSize:t,isSAB:!0})});break;default:console.warn("unhanle commands in audioworklet",e)}}handleMessageForNoSAB(t){const{status:e}=t.data;switch(e){case"encodeAudioPort":this.audioProcessBuffer.setEncodePort(t.ports[0]);break;case"decodeAudioPort":this.audioProcessBuffer.setDecodePort(t.ports[0]);break;case"close":this.audioProcessBuffer.close(),this.isPlaying=!1,this.isRunning=!1;break;default:console.warn("unhanle commands in audioworklet",e)}}process(t,e,s){return c?this.SABProcess(t,e,s):this.NoSABprocess(t,e,s)}NoSABprocess(t,e,s){return!(!this.isRunning||this.isPlaying&&(this.inputDataForNoSAB(t),this.outputDataForNoSAB(e),0))}inputDataForNoSAB(t){if(!t[0]||!t[0][0])return!0;this.audioProcessBuffer.write(t[0][0])}outputDataForNoSAB(t){let e=this.audioProcessBuffer.read();for(let s=0;s<t.length;s++)for(let i=0;i<t[s].length;i++)t[s][i].set(e)}inputData(t){if(!this.encodeSAB)return!0;this.encodeSAB.write(t[0][0])}outputData(t){if(!this.decodeSAB)return!0;let e=this.decodeSAB.read();if(null===e)return!0;for(let s=0;s<t.length;s++)for(let i=0;i<t[s].length;i++)t[s][i].set(e)}SABProcess(t,e,s){let i=t[0],a=e[0];return!(this.g_sharedbuffer&&this.sampleRate_&&a[0]&&(i[0]&&this.isCapturing&&this.inputData(t),this.outputData(e),this.aecSAB&&e&&e[0]&&e[0][0]&&this.aecSAB.write(e[0][0]),0))}})}]);